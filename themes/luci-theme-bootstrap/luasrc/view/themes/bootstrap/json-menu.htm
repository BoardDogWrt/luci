<script type="text/javascript">
	(function() {
		function get_children(node) {
			var children = [];

			for (var k in node.children) {
				if (!node.children.hasOwnProperty(k))
					continue;

				if (!node.children[k].satisfied)
					continue;

				if (!node.children[k].hasOwnProperty('title'))
					continue;

				children.push(Object.assign(node.children[k], { name: k }));
			}

			return children.sort(function(a, b) {
				return ((a.order || 1000) - (b.order || 1000));
			});
		}

		function render_tabmenu(tree, url, level) {
			var container = document.querySelector('#tabmenu'),
			    nav = E('div', { 'class': 'nav' }),
			    children = get_children(tree),
			    activeNode = null;

			for (var i = 0; i < children.length; i++) {
				var isActive = (L.env.dispatchpath[3 + (level || 0)] == children[i].name),
				    activeClass = isActive ? 'active' : '';

				nav.appendChild(E('a', { 'class': 'nav-link %s'.format(activeClass), 'href': L.url(url, children[i].name) }, [ _(children[i].title) ] ));

				if (isActive)
					activeNode = children[i];
			}

			if (nav.children.length == 0)
				return E([]);

			container.appendChild(nav);
			container.style.display = '';

			//if (activeNode)
			//	render_tabmenu(activeNode, url + '/' + activeNode.name, (level || 0) + 1);

			return nav;
		}

		function render_mainmenu_dropdown(tree, url) {
			var div = E('div', { 'class': 'dropdown-menu' }),
				children = get_children(tree);

			if (children.length == 0)
				return E([]);

			for (var i = 0; i < children.length; i++) {
				div.appendChild(E('a',
					{ 'class': 'dropdown-item', 'href': L.url(url, children[i].name) },
					[ _(children[i].title) ]
				));
			}

			return div;
		}

		function render_mainmenu(tree, url) {
			var ul = document.querySelector('#topmenu'),
			    children = get_children(tree);

			if (children.length == 0)
				return E([]);

			for (var i = 0; i < children.length; i++) {
				var dropdown = render_mainmenu_dropdown(children[i], url + '/' + children[i].name),
				    subclass = 'nav-item' + (dropdown.firstElementChild ? ' dropdown' : ''),
				    linkclass = 'nav-link' + (dropdown.firstElementChild ? ' dropdown-toggle' : ''),
				    linkurl = dropdown.firstElementChild ? '#' : L.url(url, children[i].name);

				var li = E('li', { 'class': subclass }, [
					E('a', { 'class': linkclass, 'href': linkurl }, [ _(children[i].title) ]),
					dropdown
				]);

				ul.appendChild(li);
			}

			ul.style.display = '';

			return ul;
		}

		function render_modemenu(tree) {
			var ul = document.querySelector('#modemenu'),
			    children = get_children(tree);

			for (var i = 0; i < children.length; i++) {
				var isActive = (L.env.requestpath.length ? children[i].name == L.env.requestpath[0] : i == 0);

				ul.appendChild(E('li', { 'class': isActive ? 'active' : null }, [
					E('a', { 'href': L.url(children[i].name) }, [ _(children[i].title) ]),
					' ',
					E('span', { 'class': 'divider' }, [ '|' ])
				]));

				if (isActive)
					render_mainmenu(children[i], children[i].name);
			}

			if (ul.children.length > 1)
				ul.style.display = '';
		}

		document.addEventListener('luci-loaded', function(ev) {
			var tree = <%= luci.http.write_json(luci.dispatcher.menu_json() or {}) %>,
			    node = tree,
			    url = '';

			render_modemenu(tree);

			if (L.env.dispatchpath.length >= 3) {
				for (var i = 0; i < 3 && node; i++) {
					node = node.children[L.env.dispatchpath[i]];
					url = url + (url ? '/' : '') + L.env.dispatchpath[i];
				}

				if (node)
					render_tabmenu(node, url);
			}
		});
	})();
</script>
